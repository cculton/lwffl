<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="robots" content="noindex, nofollow" />
  <title>Manager Profile ‚Äì LWFFL</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg-main: #020617;
      --card-bg: #0f172a;
      --accent: #38bdf8;
      --accent-dim: rgba(56, 189, 248, 0.15);
      --border-subtle: rgba(148, 163, 184, 0.15);
      --text-main: #f1f5f9;
      --text-muted: #94a3b8;
      --text-soft: #64748b;
      --positive: #22c55e;
      --negative: #ef4444;
      --warning: #f59e0b;
      --gold: #fbbf24;
      --silver: #cbd5e1;
      --bronze: #b45309;
      
      --ease-out: cubic-bezier(0.16, 1, 0.3, 1);
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: radial-gradient(circle at 50% 0%, #1e293b 0%, #020617 75%);
      color: var(--text-main);
      min-height: 100vh;
      padding: 32px 16px;
      line-height: 1.5;
    }

    .shell { max-width: 1200px; margin: 0 auto; }

    /* Custom Scrollbars */
    ::-webkit-scrollbar { height: 8px; width: 8px; }
    ::-webkit-scrollbar-track { background: rgba(15, 23, 42, 0.5); border-radius: 4px; }
    ::-webkit-scrollbar-thumb { background: rgba(56, 189, 248, 0.3); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--accent); }

    /* --- Controls --- */
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
      gap: 16px;
      flex-wrap: wrap;
    }

    .page-title {
      font-size: 1.5rem;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      background: linear-gradient(to right, #fff, #94a3b8);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .manager-select-wrapper {
      position: relative;
      min-width: 280px;
    }

    select {
      width: 100%;
      padding: 12px 16px;
      background-color: rgba(30, 41, 59, 0.6);
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      color: #fff;
      font-size: 1rem;
      font-weight: 500;
      appearance: none;
      cursor: pointer;
      transition: all 0.2s var(--ease-out);
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2338bdf8'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 14px center;
      background-size: 16px;
    }
    select:hover { border-color: var(--accent); background-color: rgba(30, 41, 59, 0.9); }
    select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-dim); }

    /* --- Grid Layout --- */
    .dashboard-grid {
      display: grid;
      grid-template-columns: 320px 1fr;
      grid-template-rows: auto auto;
      gap: 24px;
      margin-bottom: 40px;
    }

    /* --- Card Components --- */
    .card {
      background: var(--card-bg);
      border: 1px solid var(--border-subtle);
      border-radius: 20px;
      padding: 28px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      transition: transform 0.3s var(--ease-out), box-shadow 0.3s var(--ease-out);
    }
    
    /* Subtle gloss effect */
    .card::before {
      content: "";
      position: absolute;
      top: 0; left: 0; right: 0; height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
    }

    /* 1. Hero Card */
    .hero-card {
      grid-row: span 2;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      background: radial-gradient(circle at top right, rgba(56, 189, 248, 0.05), transparent 60%), var(--card-bg);
    }

    .avatar-wrapper {
      position: relative;
      margin-bottom: 20px;
    }
    
    .avatar {
      width: 110px;
      height: 110px;
      border-radius: 50%;
      background: linear-gradient(135deg, #0f172a, #1e293b);
      border: 2px solid var(--border-subtle);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.8rem;
      font-weight: 800;
      color: var(--accent);
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    }

    .hero-name {
      font-size: 2rem;
      font-weight: 800;
      line-height: 1.1;
      margin-bottom: 6px;
      letter-spacing: -0.02em;
    }

    .hero-tenure {
      display: inline-block;
      padding: 4px 12px;
      background: rgba(255,255,255,0.05);
      border-radius: 99px;
      color: var(--text-muted);
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 24px;
    }

    .ovr-badge {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 28px;
      position: relative;
    }
    
    /* Decorative ring */
    .ovr-ring {
      width: 80px; height: 80px;
      border-radius: 50%;
      border: 4px solid var(--accent);
      display: flex; 
      align-items: center; justify-content: center;
      box-shadow: 0 0 20px var(--accent-dim);
    }
    
    .ovr-val { font-size: 2.2rem; font-weight: 900; color: #fff; }
    .ovr-label { font-size: 0.75rem; font-weight: 700; color: var(--accent); margin-top: 8px; letter-spacing: 0.1em; }

    .trophy-case {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      width: 100%;
      padding-top: 24px;
      border-top: 1px solid var(--border-subtle);
    }
    
    .trophy {
      font-size: 1.25rem;
      background: rgba(255,255,255,0.03);
      padding: 8px;
      border-radius: 8px;
      transition: transform 0.2s;
      cursor: help;
    }
    .trophy:hover { transform: translateY(-3px); background: rgba(255,255,255,0.08); }

    /* 2. Stats Strip */
    .stats-strip {
      grid-column: 2;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
    }

    .stat-box {
      background: rgba(30, 41, 59, 0.3);
      border: 1px solid var(--border-subtle);
      border-radius: 16px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    
    .stat-label { 
      font-size: 0.7rem; 
      text-transform: uppercase; 
      font-weight: 700; 
      color: var(--text-soft); 
      letter-spacing: 0.08em; 
      margin-bottom: 8px; 
    }
    
    .stat-val { 
      font-size: 1.5rem; 
      font-weight: 800; 
      color: #fff; 
      line-height: 1;
      margin-bottom: 4px;
    }
    
    .stat-sub { font-size: 0.8rem; color: var(--text-muted); font-weight: 500; }

    /* 3. Analytics */
    .analytics-grid {
      grid-column: 2;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 24px;
    }

    .chart-card {
      min-height: 360px;
      display: flex;
      flex-direction: column;
    }

    .chart-header {
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .chart-header h3 {
      font-size: 0.95rem;
      font-weight: 700;
      color: var(--text-main);
      margin: 0;
    }
    
    .chart-icon { color: var(--accent); }

    .chart-container {
      position: relative;
      flex: 1;
      width: 100%;
      min-height: 220px;
    }

    /* 4. Rivalry Cards */
    .rivalry-col {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .rival-card {
      background: linear-gradient(to right, rgba(30,41,59,0.4), transparent);
      border-left: 4px solid var(--border-subtle);
      padding: 16px 20px;
      border-radius: 4px 12px 12px 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .rival-card.nemesis { border-left-color: var(--negative); }
    .rival-card.pigeon { border-left-color: var(--positive); }

    .rival-meta { display: flex; flex-direction: column; }
    .rival-type { font-size: 0.7rem; text-transform: uppercase; font-weight: 700; letter-spacing: 0.1em; color: var(--text-soft); margin-bottom: 4px; }
    .rival-name { font-size: 1.1rem; font-weight: 700; color: #fff; }
    
    .rival-stat { 
      text-align: right; 
      font-family: 'Courier New', monospace; 
      font-weight: 700; 
      font-size: 1.1rem; 
    }
    .nemesis .rival-stat { color: var(--negative); }
    .pigeon .rival-stat { color: var(--positive); }

    /* Heatmap */
    .heatmap-card { grid-column: 1 / -1; }
    
    .heatmap-grid {
      display: grid;
      grid-template-columns: 60px repeat(17, 1fr);
      gap: 6px;
      overflow-x: auto;
      padding-bottom: 10px;
    }
    
    .hm-header {
      font-size: 0.7rem;
      color: var(--text-soft);
      text-align: center;
      margin-bottom: 6px;
    }
    
    .hm-year {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-muted);
      display: flex;
      align-items: center;
    }
    
    .hm-cell {
      aspect-ratio: 1;
      border-radius: 4px;
      background: rgba(255,255,255,0.03);
      position: relative;
      transition: transform 0.1s;
    }
    .hm-cell:hover { transform: scale(1.15); z-index: 2; border: 1px solid rgba(255,255,255,0.2); }
    
    .hm-cell[data-res="W"] { background: var(--positive); opacity: 0.8; }
    .hm-cell[data-res="L"] { background: var(--negative); opacity: 0.8; }
    .hm-cell[data-res="T"] { background: var(--warning); opacity: 0.8; }
    
    /* Tooltip for Heatmap */
    .hm-cell::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 110%; left: 50%;
      transform: translateX(-50%);
      background: #0f172a;
      border: 1px solid var(--border-subtle);
      color: #fff;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 0.75rem;
      white-space: nowrap;
      opacity: 0; 
      pointer-events: none;
      transition: opacity 0.15s;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      z-index: 10;
    }
    .hm-cell:hover::after { opacity: 1; }

    /* --- Tabs & Tables --- */
    .tabs-nav {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      border-bottom: 1px solid var(--border-subtle);
    }
    
    .tab-btn {
      background: transparent;
      border: none;
      color: var(--text-muted);
      font-size: 0.95rem;
      font-weight: 600;
      padding: 12px 20px;
      cursor: pointer;
      position: relative;
      transition: color 0.2s;
    }
    .tab-btn:hover { color: #fff; }
    .tab-btn.active { color: var(--accent); }
    .tab-btn.active::after {
      content: '';
      position: absolute;
      bottom: -1px; left: 0; right: 0;
      height: 3px;
      background: var(--accent);
      border-radius: 3px 3px 0 0;
    }

    .table-section { display: none; }
    .table-section.active { display: block; animation: fadeUp 0.4s var(--ease-out); }
    @keyframes fadeUp { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

    .table-wrap {
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      overflow: hidden;
    }

    table { width: 100%; border-collapse: collapse; min-width: 700px; }
    
    th {
      background: rgba(15, 23, 42, 0.8);
      text-align: left;
      padding: 14px 20px;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-muted);
      border-bottom: 1px solid var(--border-subtle);
    }
    
    td {
      padding: 14px 20px;
      border-bottom: 1px solid rgba(255,255,255,0.03);
      color: var(--text-main);
      font-size: 0.95rem;
      font-variant-numeric: tabular-nums;
    }
    tr:last-child td { border-bottom: none; }
    tbody tr:hover { background: rgba(56, 189, 248, 0.03); }

    /* Skeleton Loading */
    .skeleton {
      background: rgba(255,255,255,0.05);
      border-radius: 4px;
      color: transparent !important;
      position: relative;
      overflow: hidden;
    }
    .skeleton::after {
      content: "";
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.05), transparent);
      animation: shimmer 1.5s infinite;
    }
    @keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }

    /* Responsive */
    @media (max-width: 1024px) {
      .dashboard-grid { grid-template-columns: 1fr; }
      .hero-card { 
        grid-row: auto; 
        flex-direction: row; 
        justify-content: space-between; 
        padding: 30px;
        text-align: left;
      }
      .avatar-wrapper { margin: 0; margin-right: 24px; }
      .ovr-badge { margin: 0; margin-left: auto; }
      .trophy-case { justify-content: flex-start; }
    }

    @media (max-width: 768px) {
      .hero-card { flex-direction: column; text-align: center; gap: 20px; }
      .avatar-wrapper { margin: 0; }
      .ovr-badge { margin: 0; }
      .trophy-case { justify-content: center; }
      
      .stats-strip { grid-template-columns: 1fr 1fr; }
      .analytics-grid { grid-template-columns: 1fr; }
      .chart-card { min-height: 300px; }
    }
  </style>
</head>
<body>

<div class="shell">
  
  <div class="top-bar">
    <div class="page-title">Manager Profile</div>
    <div class="manager-select-wrapper">
      <select id="managerSelect" aria-label="Select Manager"></select>
    </div>
  </div>

  <div class="dashboard-grid">
    
    <div class="card hero-card">
      <div class="avatar-wrapper">
        <div class="avatar" id="heroAvatar"></div>
      </div>
      
      <div style="flex:1">
        <div class="hero-name" id="heroName"><span class="skeleton">Loading Name</span></div>
        <div class="hero-tenure" id="heroTenure"><span class="skeleton">Est 20XX</span></div>
        <div class="trophy-case" id="trophyCase">
          </div>
      </div>

      <div class="ovr-badge">
        <div class="ovr-ring">
          <span class="ovr-val" id="heroOvr">--</span>
        </div>
        <span class="ovr-label">RATING</span>
      </div>
    </div>

    <div class="stats-strip">
      <div class="stat-box">
        <span class="stat-label">Career Record</span>
        <span class="stat-val" id="statRecord">-</span>
        <span class="stat-sub" id="statWinPct">Win %</span>
      </div>
      <div class="stat-box">
        <span class="stat-label">Avg Finish</span>
        <span class="stat-val" id="statAvgFinish">-</span>
        <span class="stat-sub">Rank</span>
      </div>
      <div class="stat-box">
        <span class="stat-label">Avg Score</span>
        <span class="stat-val" id="statAvgScore">-</span>
        <span class="stat-sub">PTS/Game</span>
      </div>
      <div class="stat-box">
        <span class="stat-label">Earnings</span>
        <span class="stat-val" id="statEarnings" style="color:var(--gold)">-</span>
        <span class="stat-sub">Total Won</span>
      </div>
    </div>

    <div class="analytics-grid">
      
      <div class="card chart-card">
        <div class="chart-header">
          <div class="chart-icon">‚ú¶</div>
          <h3>Luck Index (Quadrants)</h3>
        </div>
        <div class="chart-container">
          <canvas id="luckChart"></canvas>
        </div>
      </div>

      <div class="card chart-card">
        <div class="chart-header">
          <div class="chart-icon">üìä</div>
          <h3>Scoring Spread (Low/High)</h3>
        </div>
        <div class="chart-container">
          <canvas id="spreadChart"></canvas>
        </div>
      </div>

      <div class="rivalry-col">
        <div class="rival-card nemesis">
          <div class="rival-meta">
            <span class="rival-type">Nemesis (Lowest Win %)</span>
            <span class="rival-name" id="nemesisName">-</span>
          </div>
          <span class="rival-stat" id="nemesisStat">-</span>
        </div>
        
        <div class="rival-card pigeon">
          <div class="rival-meta">
            <span class="rival-type">Pigeon (Highest Win %)</span>
            <span class="rival-name" id="pigeonName">-</span>
          </div>
          <span class="rival-stat" id="pigeonStat">-</span>
        </div>

        <div class="card chart-card" style="flex:1;">
          <div class="chart-header">
            <div class="chart-icon">üî•</div>
            <h3>Clutch Factor (Reg vs Playoff)</h3>
          </div>
          <div class="chart-container" style="height:150px;">
            <canvas id="clutchChart"></canvas>
          </div>
        </div>
      </div>

      <div class="card chart-card">
        <div class="chart-header">
          <div class="chart-icon">üìà</div>
          <h3>Career Trajectory</h3>
        </div>
        <div class="chart-container">
          <canvas id="careerChart"></canvas>
        </div>
      </div>

      <div class="card heatmap-card">
        <div class="chart-header">
          <div class="chart-icon">üìÖ</div>
          <h3>The Heat Check (Weekly Results)</h3>
        </div>
        <div class="heatmap-grid" id="heatmapGrid"></div>
      </div>

    </div>
  </div>

  <div class="card">
    <div class="tabs-nav">
      <button class="tab-btn active" onclick="switchTab('seasons')">Season Log</button>
      <button class="tab-btn" onclick="switchTab('games')">Game Log</button>
    </div>

    <div id="tabSeasons" class="table-section active">
      <div class="table-wrap">
        <table id="seasonTable">
          <thead>
            <tr>
              <th>Year</th>
              <th>Record</th>
              <th>Finish</th>
              <th>Points For</th>
              <th>Points Against</th>
              <th>Seed</th>
              <th>Earnings</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div id="tabGames" class="table-section">
      <div class="table-wrap">
        <table id="gameTable">
          <thead>
            <tr>
              <th>Year</th>
              <th>Week</th>
              <th>Opponent</th>
              <th>Score</th>
              <th>Result</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<script>
  // --- Constants & Global State ---
  const PAYOUTS = { 1: 450, 2: 175, 3: 100, 4: 75 };
  let rawScores = [], rawStandings = [], rawSeeds = [];
  let charts = {}; 

  // --- Initialization ---
  document.addEventListener('DOMContentLoaded', async () => {
    try {
      const [sRes, stRes, sdRes] = await Promise.all([
        fetch('league-scores.json'),
        fetch('final-standings.json'),
        fetch('playoff-seeds.json')
      ]);

      if(!sRes.ok || !stRes.ok || !sdRes.ok) throw new Error("Data load failed");

      rawScores = await sRes.json();
      rawStandings = await stRes.json();
      rawSeeds = await sdRes.json();

      initManagerDropdown();
      
      // Load first manager
      const firstMgr = document.getElementById('managerSelect').options[0].value;
      loadManager(firstMgr);

    } catch (err) {
      console.error(err);
      document.querySelector('.shell').innerHTML = `<div style="text-align:center; padding:60px; color:#64748b;">Unable to load league data.<br>Please ensure JSON files are present.</div>`;
    }
  });

  function initManagerDropdown() {
    const managers = new Set();
    rawStandings.forEach(s => { if(s.manager) managers.add(s.manager); });
    
    const select = document.getElementById('managerSelect');
    Array.from(managers).sort().forEach(m => {
      const opt = document.createElement('option');
      opt.value = m;
      opt.textContent = m;
      select.appendChild(opt);
    });

    select.addEventListener('change', (e) => loadManager(e.target.value));
  }

  // --- Core Data Processor ---
  function loadManager(name) {
    // 1. Filter Data
    const mySeasons = rawStandings.filter(s => s.manager === name).sort((a,b) => b.year - a.year);
    const myGames = [];
    const h2h = {};

    rawScores.forEach(m => {
      let isMyGame = false, myScore = 0, oppScore = 0, oppName = "";

      if(m.manager1 === name) {
        isMyGame = true; myScore = Number(m.score1); oppScore = Number(m.score2); oppName = m.manager2;
      } else if (m.manager2 === name) {
        isMyGame = true; myScore = Number(m.score2); oppScore = Number(m.score1); oppName = m.manager1;
      }

      if (isMyGame && !isNaN(myScore)) {
        const result = myScore > oppScore ? 'W' : (myScore < oppScore ? 'L' : 'T');
        myGames.push({
          year: Number(m.year),
          week: Number(m.week),
          score: myScore,
          oppScore: oppScore,
          opponent: oppName,
          result: result,
          isPlayoff: (m.playoffs && m.playoffs !== "N/A")
        });

        if(oppName) {
          if(!h2h[oppName]) h2h[oppName] = { w:0, l:0, t:0, games:0 };
          h2h[oppName].games++;
          if(result === 'W') h2h[oppName].w++;
          else if(result === 'L') h2h[oppName].l++;
          else h2h[oppName].t++;
        }
      }
    });

    // 2. Render UI
    renderHero(name, mySeasons, myGames);
    renderStats(mySeasons, myGames);
    renderRivalries(h2h);
    renderTables(mySeasons, myGames);
    
    // 3. Render Charts
    renderLuckChart(mySeasons);
    renderSpreadChart(myGames);
    renderClutchChart(myGames);
    renderCareerChart(mySeasons);
    renderHeatmap(myGames);
  }

  // --- Renderers ---

  function renderHero(name, seasons, games) {
    const initials = name.split(' ').map(n => n[0]).join('').substring(0,2);
    document.getElementById('heroAvatar').textContent = initials;
    document.getElementById('heroName').textContent = name;
    
    if(seasons.length > 0) {
      const minYear = Math.min(...seasons.map(s => s.year));
      const maxYear = Math.max(...seasons.map(s => s.year));
      document.getElementById('heroTenure').textContent = `EST. ${minYear}`;
    }

    const caseEl = document.getElementById('trophyCase');
    caseEl.innerHTML = '';
    let champCount = 0;
    seasons.forEach(s => {
      const rank = s.final_standing ?? s.finalStanding;
      if (rank === 1) { champCount++; caseEl.innerHTML += `<span class="trophy" title="${s.year} Champion">üèÜ</span>`; }
      else if (rank === 2) caseEl.innerHTML += `<span class="trophy" title="${s.year} Runner-up">ü•à</span>`;
      else if (rank === 3) caseEl.innerHTML += `<span class="trophy" title="${s.year} 3rd Place">ü•â</span>`;
    });

    // OVR Formula
    const wins = games.filter(g => g.result === 'W').length;
    const winPct = games.length ? wins / games.length : 0;
    const seeds = rawSeeds.filter(s => s.manager === name);
    let ovr = 60 + (winPct * 25) + (champCount * 8) + (seeds.length * 1.5);
    if(ovr > 99) ovr = 99;
    
    // Animate OVR
    const ovrEl = document.getElementById('heroOvr');
    let start = 0;
    const animate = () => {
      start += 2;
      if(start > ovr) start = Math.round(ovr);
      ovrEl.textContent = start;
      if(start < ovr) requestAnimationFrame(animate);
    };
    animate();
  }

  function renderStats(seasons, games) {
    const w = games.filter(g => g.result === 'W').length;
    const l = games.filter(g => g.result === 'L').length;
    const t = games.filter(g => g.result === 'T').length;
    document.getElementById('statRecord').textContent = `${w}-${l}-${t}`;
    
    const pct = games.length ? (w + t*0.5) / games.length : 0;
    document.getElementById('statWinPct').textContent = pct.toFixed(3);

    const validFinishes = seasons.map(s => s.final_standing ?? s.finalStanding).filter(f => f);
    const avgFin = validFinishes.length ? validFinishes.reduce((a,b)=>a+b,0) / validFinishes.length : 0;
    document.getElementById('statAvgFinish').textContent = avgFin > 0 ? avgFin.toFixed(1) : '-';

    const totalScore = games.reduce((a,b) => a + b.score, 0);
    const avgScore = games.length ? totalScore / games.length : 0;
    document.getElementById('statAvgScore').textContent = avgScore.toFixed(1);

    let money = 0;
    seasons.forEach(s => {
      const rank = s.final_standing ?? s.finalStanding;
      if (PAYOUTS[rank]) money += PAYOUTS[rank];
    });
    document.getElementById('statEarnings').textContent = `$${money.toLocaleString()}`;
  }

  function renderRivalries(h2h) {
    let nemesis = { name: '-', pct: 1.0, rec: '' };
    let pigeon = { name: '-', pct: 0.0, rec: '' };

    Object.keys(h2h).forEach(opp => {
      const d = h2h[opp];
      if (d.games < 5) return; // Sample size
      const pct = (d.w + d.t*0.5) / d.games;

      if (pct <= nemesis.pct) nemesis = { name: opp, pct: pct, rec: `${d.w}-${d.l}` };
      if (pct >= pigeon.pct) pigeon = { name: opp, pct: pct, rec: `${d.w}-${d.l}` };
    });

    document.getElementById('nemesisName').textContent = nemesis.name;
    document.getElementById('nemesisStat').textContent = nemesis.rec || '-';
    
    document.getElementById('pigeonName').textContent = pigeon.name;
    document.getElementById('pigeonStat').textContent = pigeon.rec || '-';
  }

  function renderTables(seasons, games) {
    const tbodyS = document.querySelector('#seasonTable tbody');
    tbodyS.innerHTML = '';
    seasons.forEach(s => {
      const wins = s.wins || 0; const losses = s.losses || 0; const ties = s.ties || 0;
      const seedData = rawSeeds.find(sd => sd.manager === s.manager && sd.year === s.year);
      const seed = seedData ? seedData.seed : '-';
      let money = 0;
      const rank = s.final_standing ?? s.finalStanding;
      if (PAYOUTS[rank]) money = PAYOUTS[rank];

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${s.year}</td>
        <td>${wins}-${losses}-${ties}</td>
        <td>${rank || '-'}</td>
        <td style="color:var(--positive)">${Math.round(s.points_for || 0).toLocaleString()}</td>
        <td style="color:var(--negative)">${Math.round(s.points_against || 0).toLocaleString()}</td>
        <td>${seed}</td>
        <td style="color:${money>0?'var(--gold)':'inherit'}">${money > 0 ? '$'+money : '-'}</td>
      `;
      tbodyS.appendChild(tr);
    });

    const tbodyG = document.querySelector('#gameTable tbody');
    tbodyG.innerHTML = '';
    const recentGames = [...games].sort((a,b) => {
      if(a.year !== b.year) return b.year - a.year;
      return b.week - a.week;
    }).slice(0, 50);

    recentGames.forEach(g => {
      const tr = document.createElement('tr');
      const resClass = g.result === 'W' ? 'color:var(--positive); font-weight:700;' : (g.result === 'L' ? 'color:var(--negative); font-weight:700;' : '');
      tr.innerHTML = `
        <td>${g.year}</td>
        <td>Week ${g.week}</td>
        <td>${g.opponent}</td>
        <td>${g.score.toFixed(2)}</td>
        <td style="${resClass}">${g.result}</td>
      `;
      tbodyG.appendChild(tr);
    });
  }

  // --- Charts Logic ---
  // Common Chart Options
  Chart.defaults.color = '#64748b';
  Chart.defaults.font.family = 'system-ui';
  const commonOptions = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: { legend: { display: false } }
  };

  function renderLuckChart(seasons) {
    let totalPF = 0, totalPA = 0;
    seasons.forEach(s => { totalPF += (s.points_for || 0); totalPA += (s.points_against || 0); });
    const avgPF = seasons.length ? totalPF/seasons.length : 0;
    const avgPA = seasons.length ? totalPA/seasons.length : 0;

    const ctx = document.getElementById('luckChart').getContext('2d');
    if (charts.luck) charts.luck.destroy();

    // Plugin for quadrants
    const quadrantPlugin = {
      id: 'quadrants',
      beforeDraw(chart) {
        const {ctx, chartArea: {top, bottom, left, right}, scales: {x, y}} = chart;
        const midX = x.getPixelForValue(avgPF);
        const midY = y.getPixelForValue(avgPA);

        ctx.save();
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
        ctx.lineWidth = 1;
        ctx.setLineDash([4, 4]);
        
        ctx.beginPath();
        ctx.moveTo(midX, top); ctx.lineTo(midX, bottom);
        ctx.moveTo(left, midY); ctx.lineTo(right, midY);
        ctx.stroke();

        ctx.font = '600 9px system-ui';
        ctx.fillStyle = 'rgba(255, 255, 255, 0.4)';
        ctx.textAlign = 'center';
        
        ctx.fillText("SHOOTOUTS", (midX + right)/2, top + 15);
        ctx.fillText("UNLUCKY", (left + midX)/2, top + 15);
        ctx.fillText("DOMINANT", (midX + right)/2, bottom - 10);
        ctx.fillText("DEFENSIVE", (left + midX)/2, bottom - 10);
        ctx.restore();
      }
    };

    charts.luck = new Chart(ctx, {
      type: 'scatter',
      data: {
        datasets: [{
          data: seasons.map(s => ({ x: s.points_for, y: s.points_against, year: s.year })),
          backgroundColor: '#38bdf8',
          pointRadius: 6,
          pointHoverRadius: 8
        }]
      },
      plugins: [quadrantPlugin],
      options: {
        ...commonOptions,
        scales: {
          x: { title: {display:true, text:'PF'}, grid: {display:false} },
          y: { title: {display:true, text:'PA'}, grid: {display:false} }
        },
        plugins: {
          tooltip: { callbacks: { label: c => `${c.raw.year}: PF ${Math.round(c.raw.x)}` } }
        }
      }
    });
  }

  function renderSpreadChart(games) {
    const years = [...new Set(games.map(g => g.year))].sort((a,b)=>a-b);
    const data = years.map(y => {
      const scores = games.filter(g => g.year === y).map(g => g.score);
      return [Math.min(...scores), Math.max(...scores)];
    });

    const ctx = document.getElementById('spreadChart').getContext('2d');
    if (charts.spread) charts.spread.destroy();

    charts.spread = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: years,
        datasets: [{
          data: data,
          backgroundColor: 'rgba(56, 189, 248, 0.4)',
          borderWidth: 0,
          borderSkipped: false,
          barPercentage: 0.6
        }]
      },
      options: {
        ...commonOptions,
        scales: {
          y: { min: 40, grid: { color: 'rgba(255,255,255,0.05)' } },
          x: { grid: { display: false } }
        }
      }
    });
  }

  function renderClutchChart(games) {
    const reg = games.filter(g => !g.isPlayoff).map(g => g.score);
    const play = games.filter(g => g.isPlayoff).map(g => g.score);
    const regAvg = reg.length ? reg.reduce((a,b)=>a+b,0)/reg.length : 0;
    const playAvg = play.length ? play.reduce((a,b)=>a+b,0)/play.length : 0;

    const ctx = document.getElementById('clutchChart').getContext('2d');
    if (charts.clutch) charts.clutch.destroy();

    charts.clutch = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['Regular', 'Playoffs'],
        datasets: [{
          data: [regAvg, playAvg],
          backgroundColor: ['#38bdf8', '#fbbf24'],
          borderRadius: 4
        }]
      },
      options: {
        ...commonOptions,
        indexAxis: 'y',
        scales: {
          x: { grid: { display: false }, ticks: { color: '#94a3b8' } },
          y: { grid: { display: false }, ticks: { color: '#fff', font: {weight:'bold'} } }
        }
      }
    });
  }

  function renderCareerChart(seasons) {
    const sorted = [...seasons].sort((a,b) => a.year - b.year);
    const ctx = document.getElementById('careerChart').getContext('2d');
    if (charts.career) charts.career.destroy();

    charts.career = new Chart(ctx, {
      type: 'line',
      data: {
        labels: sorted.map(s => s.year),
        datasets: [{
          data: sorted.map(s => s.final_standing ?? null),
          borderColor: '#38bdf8',
          backgroundColor: 'rgba(56, 189, 248, 0.1)',
          borderWidth: 2,
          tension: 0.3,
          fill: true,
          pointBackgroundColor: '#0f172a',
          pointBorderColor: '#38bdf8',
          pointBorderWidth: 2
        }]
      },
      options: {
        ...commonOptions,
        scales: {
          y: { reverse: true, min: 1, max: 12, grid: { color: 'rgba(255,255,255,0.05)' } },
          x: { grid: { display: false } }
        }
      }
    });
  }

  function renderHeatmap(games) {
    const grid = document.getElementById('heatmapGrid');
    grid.innerHTML = '';

    // Header
    const header = document.createElement('div');
    header.className = 'hm-header';
    grid.appendChild(header);
    for(let w=1; w<=17; w++) {
      const h = document.createElement('div');
      h.className = 'hm-header';
      h.textContent = w;
      grid.appendChild(h);
    }

    // Body
    const years = [...new Set(games.map(g => g.year))].sort((a,b)=>b-a);
    years.forEach(y => {
      const yLabel = document.createElement('div');
      yLabel.className = 'hm-year';
      yLabel.textContent = y;
      grid.appendChild(yLabel);

      for(let w=1; w<=17; w++) {
        const game = games.find(g => g.year === y && g.week === w);
        const cell = document.createElement('div');
        cell.className = 'hm-cell';
        
        if (game) {
          cell.dataset.res = game.result;
          cell.dataset.tooltip = `Wk ${w}: ${game.result} vs ${game.opponent || '?'} (${Math.round(game.score)})`;
        }
        grid.appendChild(cell);
      }
    });
  }

  window.switchTab = function(tab) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.table-section').forEach(s => s.classList.remove('active'));
    
    if(tab === 'seasons') {
      document.querySelector('button[onclick="switchTab(\'seasons\')"]').classList.add('active');
      document.getElementById('tabSeasons').classList.add('active');
    } else {
      document.querySelector('button[onclick="switchTab(\'games\')"]').classList.add('active');
      document.getElementById('tabGames').classList.add('active');
    }
  }
</script>
</body>
</html>
