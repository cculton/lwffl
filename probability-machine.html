<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="robots" content="noindex, nofollow" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Probability Machine – LWFFL</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg-main: #020617;
      --card-bg: #020617;
      --accent: #38bdf8;
      --border-subtle: #1f2937;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --text-soft: #6b7280;
      --positive: #22c55e;
      --negative: #ef4444;
      --warning: #f59e0b;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #020617 0%, #020617 35%, #020617 100%);
      color: var(--text-main);
      min-height: 100vh;
      padding: 24px 16px;
    }

    .shell { max-width: 1000px; margin: 0 auto; }

    .container {
      background:
        radial-gradient(circle at top left, rgba(56, 189, 248, 0.12), transparent 55%),
        radial-gradient(circle at bottom right, rgba(59, 130, 246, 0.18), transparent 55%),
        var(--card-bg);
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      box-shadow: 0 40px 80px rgba(0,0,0,0.8), 0 0 0 1px rgba(15,23,42,0.9);
      padding: 32px 24px;
      backdrop-filter: blur(14px);
    }

    .header { text-align: center; margin-bottom: 30px; }
    .header h1 {
      font-size: 2rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      font-weight: 700;
      margin-bottom: 6px;
      color: #f9fafb;
    }
    .header p {
      color: var(--text-soft);
      font-size: 0.9rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
    }

    /* Tabs */
    .tabs {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 24px;
    }
    .tab-btn {
      padding: 10px 20px;
      border-radius: 999px;
      border: 1px solid rgba(55,65,81,0.9);
      background: rgba(15,23,42,0.6);
      color: var(--text-muted);
      font-weight: 600;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      cursor: pointer;
      transition: all 0.2s;
    }
    .tab-btn.active {
      background: rgba(56,189,248,0.15);
      border-color: var(--accent);
      color: var(--accent);
      box-shadow: 0 0 15px rgba(56,189,248,0.2);
    }

    .section { display: none; animation: fadeIn 0.4s ease; }
    .section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* Instructions */
    .instruction-text {
      text-align: center;
      color: var(--text-soft);
      font-size: 0.95rem;
      margin-bottom: 20px;
      line-height: 1.5;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }
    .highlight { color: var(--text-main); font-weight: 600; }

    /* Inputs */
    .input-row {
      display: flex;
      gap: 15px;
      margin-bottom: 24px;
      align-items: flex-end;
      background: rgba(30, 41, 59, 0.4);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid rgba(55,65,81,0.5);
    }
    .input-group { flex: 1; }
    
    label {
      display: block;
      margin-bottom: 8px;
      color: var(--text-muted);
      font-weight: 600;
      font-size: 0.8rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
    }
    
    input[type="number"], select {
      width: 100%;
      padding: 12px 15px;
      background: #0b1120;
      border: 1px solid rgba(75, 85, 99, 0.8);
      border-radius: 8px;
      color: #f9fafb;
      font-size: 1.1em;
      transition: border-color 0.2s;
    }
    select {
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%239ca3af' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 15px center;
    }
    input:focus, select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 1px rgba(56,189,248,0.5); }
    
    /* Placeholder styling */
    ::placeholder {
      color: rgba(156, 163, 175, 0.4) !important;
      opacity: 1; 
    }

    button.action-btn {
      padding: 12px 24px;
      background: linear-gradient(135deg, rgba(56,189,248,0.1) 0%, rgba(59,130,246,0.2) 100%);
      border: 1px solid rgba(56,189,248,0.5);
      color: var(--accent);
      border-radius: 8px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      cursor: pointer;
      transition: all 0.2s;
      height: 48px;
    }
    button.action-btn:hover {
      background: rgba(56,189,248,0.25);
      box-shadow: 0 0 20px rgba(56,189,248,0.3);
      transform: translateY(-1px);
    }

    /* Results */
    .result-card {
      background: radial-gradient(circle at top, rgba(15,23,42,0.9), rgba(2,6,23,0.95));
      border: 1px solid rgba(55,65,81,0.6);
      border-radius: 14px;
      padding: 30px;
      text-align: center;
      margin-bottom: 24px;
      display: none;
    }
    .result-card.show { display: block; }

    /* Season Footer Style */
    .result-footer {
      margin-top: 24px;
      padding-top: 20px;
      border-top: 1px solid rgba(55,65,81,0.5);
      color: var(--text-soft);
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .main-stat-label { color: var(--text-soft); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.12em; margin-bottom: 10px; }
    .main-stat-val { 
      font-size: 3.5rem; 
      font-weight: 800; 
      color: #f9fafb; 
      line-height: 1;
      margin-bottom: 5px;
      background: linear-gradient(135deg, #fff 0%, #94a3b8 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .main-stat-sub { font-size: 1.2rem; color: var(--accent); font-weight: 600; margin-bottom: 20px; }

    .context-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 15px;
      margin-top: 24px;
      border-top: 1px solid rgba(55,65,81,0.5);
      padding-top: 20px;
    }
    .context-box {
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(55,65,81,0.4);
      border-radius: 8px;
      padding: 12px;
    }
    .context-title { font-size: 0.7rem; text-transform: uppercase; color: var(--text-muted); margin-bottom: 4px; letter-spacing: 0.05em; }
    .context-data { font-size: 1.2rem; font-weight: 700; color: #e5e7eb; }

    /* Chart */
    .chart-box {
      position: relative;
      height: 300px;
      background: rgba(2, 6, 23, 0.5);
      border: 1px solid rgba(55, 65, 81, 0.5);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 20px;
    }

    .info-text {
      background: rgba(56, 189, 248, 0.08);
      border-left: 3px solid var(--accent);
      padding: 15px;
      border-radius: 6px;
      font-size: 0.95rem;
      line-height: 1.5;
      color: #e2e8f0;
      margin-top: 20px;
      text-align: left;
    }

    /* Season Predictor Specifics */
    .odds-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-top: 20px;
    }
    .odds-card {
      background: rgba(15,23,42,0.8);
      border: 1px solid rgba(55,65,81,0.6);
      border-radius: 12px;
      padding: 20px 10px;
      text-align: center;
      transition: transform 0.2s;
    }
    .odds-card:hover { transform: translateY(-3px); border-color: var(--accent); }
    .odds-title { font-size: 0.8rem; text-transform: uppercase; color: var(--text-muted); margin-bottom: 8px; letter-spacing: 0.1em; }
    .odds-val { font-size: 2rem; font-weight: 800; color: #f9fafb; }
    .odds-sub { font-size: 0.75rem; color: var(--text-soft); margin-top: 4px; }

    .odds-high { color: var(--positive); }
    .odds-med { color: var(--warning); }
    .odds-low { color: var(--negative); }

    .loading { color: var(--text-soft); text-align: center; padding: 40px; }

    @media (max-width: 600px) {
      .input-row { flex-direction: column; align-items: stretch; }
      .odds-grid { grid-template-columns: 1fr; }
      .main-stat-val { font-size: 2.8rem; }
    }
  </style>
</head>
<body>

<div class="shell">
  <div class="container">
    <div class="header">
      <h1>Probability Machine</h1>
      <p>Legion of Whom Fantasy Football League</p>
    </div>

    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('weekly')">Win Predictor</button>
      <button class="tab-btn" onclick="switchTab('season')">Playoff Predictor</button>
    </div>

    <div id="weeklySection" class="section active">
      <p class="instruction-text">
        Enter a fantasy score to calculate its win probability based on <span id="weeklyCount" class="highlight">0</span> historical scores. 
        The model fits a normal distribution to every score recorded in league history based on the selected matchup type.
      </p>

      <div class="input-row">
        <div class="input-group">
          <label for="matchupType">Matchup Type</label>
          <select id="matchupType" onchange="processWeeklyData(); if(document.getElementById('scoreInput').value) calcWeekly();">
            <option value="Reg">Regular Season</option>
            <option value="Playoffs">Playoffs</option>
          </select>
        </div>
        <div class="input-group">
          <label for="scoreInput">Your Score</label>
          <input type="number" id="scoreInput" placeholder="e.g., 105.5" step="0.1">
        </div>
        <button class="action-btn" onclick="calcWeekly()">Calculate Win %</button>
      </div>

      <div id="weeklyResult" class="result-card">
        <div class="main-stat-label">Win Probability</div>
        <div class="main-stat-val" id="winProbDisplay">-</div>
        
        <div class="info-text" id="weeklyInterp">Enter a score to see how it stacks up against historical data.</div>

        <div class="context-grid">
          <div class="context-box">
            <div class="context-title">League Average</div>
            <div class="context-data" id="leagueMean">-</div>
          </div>
          <div class="context-box">
            <div class="context-title">Standard Dev</div>
            <div class="context-data" id="leagueStd">-</div>
          </div>
          <div class="context-box">
            <div class="context-title">Vs Average</div>
            <div class="context-data" id="vsAvgDisplay">-</div>
          </div>
        </div>
      </div>

      <div class="chart-box">
        <canvas id="scoreChart"></canvas>
      </div>
    </div>

    <div id="seasonSection" class="section">
      <p class="instruction-text">
        Enter a win total or PPM to compare against <span id="seasonCount" class="highlight">0</span> historical seasons.
        The model identifies teams with <strong>similar profiles</strong> to project playoff and championship odds.
      </p>

      <div class="input-row">
        <div class="input-group">
          <label for="winsInput">Season Wins</label>
          <input type="number" id="winsInput" placeholder="e.g., 8" min="0" max="14">
        </div>
        <div class="input-group">
          <label style="text-transform:none; font-size:0.75rem; color:var(--text-soft); text-align:center; padding-top:10px;">— OR —</label>
        </div>
        <div class="input-group">
          <label for="ppgInput">Points Per Matchup (PPM)</label>
          <input type="number" id="ppgInput" placeholder="e.g., 100.5" step="0.1">
        </div>
        <button class="action-btn" onclick="calcSeason()">Get Odds</button>
      </div>

      <div id="seasonResult" class="result-card">
        <div class="odds-grid">
          <div class="odds-card">
            <div class="odds-title">Make Playoffs</div>
            <div class="odds-val" id="probPlayoffs">-</div>
          </div>
          <div class="odds-card">
            <div class="odds-title">Reach Championship</div>
            <div class="odds-val" id="probFinals">-</div>
          </div>
          <div class="odds-card">
            <div class="odds-title">Win Championship</div>
            <div class="odds-val" id="probChamp">-</div>
          </div>
        </div>
        
        <div class="result-footer">
           Historical probability based on <span id="seasonSampleSize" style="color:var(--text-main); font-weight:700;">0</span> teams with similar profiles
        </div>
      </div>
    </div>

    <div id="loading" class="loading">Loading database...</div>

  </div>
</div>

<script>
  // --- Global Data Containers ---
  let rawMatchups = [];
  let seasonStats = [];
  let leagueMeta = { mean: 0, std: 0, scores: [] };
  let historyModel = []; 
  let chartInstance = null;

  // --- Init ---
  document.addEventListener('DOMContentLoaded', async () => {
    try {
      const [scoresRes, statsRes] = await Promise.all([
        fetch('league-scores.json'),
        fetch('final-standings.json')
      ]);
      
      if(!scoresRes.ok || !statsRes.ok) throw new Error("File load error");

      rawMatchups = await scoresRes.json();
      seasonStats = await statsRes.json();

      processWeeklyData(); // Will default to Regular Season
      processHistoricalModel();
      
      // Update dynamic counts with commas
      document.getElementById('seasonCount').textContent = seasonStats.length.toLocaleString();

      document.getElementById('loading').style.display = 'none';
      
    } catch (err) {
      console.error(err);
      document.getElementById('loading').textContent = "Error loading data files. Ensure JSONs are present.";
    }
  });

  // --- Tab Switching ---
  window.switchTab = function(tab) {
    document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
    
    if (tab === 'weekly') {
      document.getElementById('weeklySection').classList.add('active');
      document.querySelector('button[onclick="switchTab(\'weekly\')"]').classList.add('active');
    } else {
      document.getElementById('seasonSection').classList.add('active');
      document.querySelector('button[onclick="switchTab(\'season\')"]').classList.add('active');
    }
  };

  // --- Data Processing: Weekly ---
  function processWeeklyData() {
    const filterType = document.getElementById('matchupType').value;
    const scores = [];
    
    rawMatchups.forEach(m => {
      // Determine if matchup is Playoff
      const isPlayoff = (m.playoffs && m.playoffs !== "N/A");
      
      let include = false;
      if (filterType === 'Reg' && !isPlayoff) include = true;
      if (filterType === 'Playoffs' && isPlayoff) include = true;

      if (include) {
        if (m.score1) scores.push(Number(m.score1));
        if (m.score2) scores.push(Number(m.score2));
      }
    });

    // Update count display
    document.getElementById('weeklyCount').textContent = scores.length.toLocaleString();

    if (scores.length === 0) {
        leagueMeta = { mean: 0, std: 0, scores: [] };
        renderChart();
        return;
    }

    const sum = scores.reduce((a, b) => a + b, 0);
    const mean = sum / scores.length;
    const variance = scores.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / scores.length;
    const std = Math.sqrt(variance);

    leagueMeta = { mean, std, scores: scores.sort((a,b)=>a-b) };

    document.getElementById('leagueMean').textContent = mean.toFixed(2);
    document.getElementById('leagueStd').textContent = std.toFixed(2);
    
    // Refresh chart with new data
    renderChart();
  }

  // --- Data Processing: Historical Model ---
  function processHistoricalModel() {
    // Determine playoff teams via matchups
    const playoffTeams = {}; 
    
    rawMatchups.forEach(m => {
      if (m.playoffs && m.playoffs !== "N/A") {
        const y = m.year;
        if (!playoffTeams[y]) playoffTeams[y] = new Set();
        if (m.manager1) playoffTeams[y].add(m.manager1);
        if (m.manager2) playoffTeams[y].add(m.manager2);
      }
    });

    historyModel = seasonStats.map(s => {
      const wins = s.wins || 0;
      const matchups = (s.wins||0) + (s.losses||0) + (s.ties||0);
      const points = s.points_for || 0;
      const ppg = matchups > 0 ? (points / matchups) : 0;
      const rank = s.final_standing || 99;

      const isChamp = (rank === 1);
      const isFinals = (rank <= 2);
      // Fallback if final_standing isn't reliable for Playoffs: check if they played in playoff matchups
      let isPlayoffs = (rank <= 6); 
      if (playoffTeams[s.year] && playoffTeams[s.year].has(s.manager)) {
        isPlayoffs = true;
      }

      return { wins, ppg, isPlayoffs, isFinals, isChamp, year: s.year, manager: s.manager };
    });
  }

  // --- Calculation: Weekly ---
  window.calcWeekly = function() {
    const val = parseFloat(document.getElementById('scoreInput').value);
    if (isNaN(val)) return;

    // Normal CDF
    const z = (val - leagueMeta.mean) / leagueMeta.std;
    // Approximation of CDF
    const t = 1 / (1 + .2316419 * Math.abs(z));
    const d = .3989423 * Math.exp(-z * z / 2);
    let prob = d * t * (.3193815 + t * (-.3565638 + t * (1.781478 + t * (-1.821256 + t * 1.330274))));
    if (z > 0) prob = 1 - prob;
    
    const percent = (prob * 100).toFixed(1);
    const diff = (val - leagueMeta.mean).toFixed(1);

    document.getElementById('winProbDisplay').textContent = `${percent}%`;
    document.getElementById('vsAvgDisplay').textContent = (diff > 0 ? "+" : "") + diff;
    document.getElementById('weeklyResult').classList.add('show');

    // Update Interpretation: New 6-Tier Logic
    const el = document.getElementById('weeklyInterp');
    let html = '';
    
    if (prob >= 0.90) {
        html = `<span style="color:var(--positive)">Dominant.</span> Absolute powerhouse score.`;
    } else if (prob >= 0.75) {
        html = `<span style="color:var(--positive)">Strong Favorite.</span> You should win this handily.`;
    } else if (prob >= 0.60) {
        html = `<span style="color:#38bdf8">Solid.</span> Odds are definitely in your favor.`;
    } else if (prob >= 0.40) {
        html = `<span style="color:var(--warning)">Coin Flip.</span> This could go either way.`;
    } else if (prob >= 0.20) {
        html = `<span style="color:var(--negative)">Underdog.</span> You'll need your opponent to struggle.`;
    } else {
        html = `<span style="color:var(--negative)">Miracle Needed.</span> Start praying to the fantasy gods.`;
    }
    el.innerHTML = html;

    updateChartHighlight(val);
  };

  // --- Calculation: Season ---
  window.calcSeason = function() {
    const wInput = document.getElementById('winsInput').value;
    const pInput = document.getElementById('ppgInput').value;
    
    if (!wInput && !pInput) {
      alert("Please enter Wins OR PPG.");
      return;
    }

    let subset = [];
    let label = "";

    if (wInput) {
      const w = parseInt(wInput);
      subset = historyModel.filter(t => t.wins === w);
      if (subset.length < 5) {
        subset = historyModel.filter(t => t.wins >= w - 1 && t.wins <= w + 1);
      }
      label = `${w} Wins`;
    } else {
      const p = parseFloat(pInput);
      const range = p * 0.05; // +/- 5%
      subset = historyModel.filter(t => t.ppg >= p - range && t.ppg <= p + range);
      label = `${p} PPG`;
    }

    if (subset.length === 0) {
      alert("No historical teams found with similar profiles.");
      return;
    }

    const n = subset.length;
    const nPlayoffs = subset.filter(x => x.isPlayoffs).length;
    const nFinals = subset.filter(x => x.isFinals).length;
    const nChamp = subset.filter(x => x.isChamp).length;

    updateOddsUI('probPlayoffs', nPlayoffs, n);
    updateOddsUI('probFinals', nFinals, n);
    updateOddsUI('probChamp', nChamp, n);

    // Update the consolidated count with commas
    document.getElementById('seasonSampleSize').textContent = n.toLocaleString();

    document.getElementById('seasonResult').classList.add('show');
  }

  function updateOddsUI(id, count, total) {
    const pct = (count / total) * 100;
    const el = document.getElementById(id);
    el.textContent = `${pct.toFixed(0)}%`;
    
    el.className = 'odds-val'; // reset
    if (pct >= 70) el.classList.add('odds-high');
    else if (pct >= 40) el.classList.add('odds-med');
    else el.classList.add('odds-low');
  }

  // --- Charting ---
  function renderChart() {
    const ctx = document.getElementById('scoreChart').getContext('2d');
    
    // If chart exists, destroy it before re-creating
    if (chartInstance) {
        chartInstance.destroy();
    }

    // Generate buckets - Start from 0 per request
    const bucketSize = 10;
    const bins = {};
    const maxScore = leagueMeta.scores.length ? Math.max(...leagueMeta.scores) : 200;
    const limit = Math.ceil(maxScore / 10) * 10 + 10;

    for(let i=0; i<=limit; i+=bucketSize) bins[i] = 0;
    
    leagueMeta.scores.forEach(s => {
      const b = Math.floor(s / bucketSize) * bucketSize;
      if (bins[b] !== undefined) bins[b]++;
    });

    const labels = Object.keys(bins);
    const data = Object.values(bins);

    // Create Color Arrays to Hide 0 values
    // If value is 0, make it transparent. Otherwise default color.
    const bgColors = data.map(v => v > 0 ? 'rgba(56, 189, 248, 0.3)' : 'transparent');
    const borderColors = data.map(v => v > 0 ? '#38bdf8' : 'transparent');

    Chart.defaults.color = '#9ca3af';
    Chart.defaults.borderColor = '#1f2937';

    chartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Frequency',
          data: data,
          backgroundColor: bgColors,
          borderColor: borderColors,
          borderWidth: 1,
          borderRadius: 4,
          hoverBackgroundColor: '#38bdf8',
          minBarLength: 5 // Ensures 1s are visible, while 0s are hidden via transparent color
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          y: { beginAtZero: true, grid: { color: 'rgba(55,65,81,0.2)' } },
          x: { grid: { display: false } }
        }
      }
    });
    
    // Re-apply highlight if a score is entered
    const currentInput = document.getElementById('scoreInput').value;
    if(currentInput) updateChartHighlight(currentInput);
  }

  function updateChartHighlight(userScore) {
    if (!chartInstance) return;
    
    const bucket = Math.floor(userScore / 10) * 10;
    const data = chartInstance.data.datasets[0].data;
    
    // Highlight the user's bucket, keep 0s transparent
    const bgColors = chartInstance.data.labels.map((l, i) => {
      const val = data[i];
      if (val === 0) return 'transparent';
      return parseInt(l) === bucket ? '#22c55e' : 'rgba(56, 189, 248, 0.3)';
    });

    const borderColors = chartInstance.data.labels.map((l, i) => {
      const val = data[i];
      if (val === 0) return 'transparent';
      return parseInt(l) === bucket ? '#22c55e' : '#38bdf8';
    });

    chartInstance.data.datasets[0].backgroundColor = bgColors;
    chartInstance.data.datasets[0].borderColor = borderColors;
    chartInstance.update();
  }

</script>
</body>
</html>
