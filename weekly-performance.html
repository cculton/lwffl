<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="robots" content="noindex, nofollow">
  <title>Weekly Averages â€“ LWFFL</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg-main: #020617;
      --card-bg: #020617;
      --accent: #38bdf8;
      --border-subtle: #1f2937;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --text-soft: #6b7280;
      --positive: #22c55e;
      --negative: #ef4444;
      --warning: #f59e0b;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #020617 0%, #020617 35%, #020617 100%);
      color: var(--text-main);
      min-height: 100vh;
      padding: 24px 16px;
    }

    .shell { max-width: 1000px; margin: 0 auto; }

    .container {
      background:
        radial-gradient(circle at top left, rgba(56, 189, 248, 0.12), transparent 55%),
        radial-gradient(circle at bottom right, rgba(59, 130, 246, 0.18), transparent 55%),
        var(--card-bg);
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      box-shadow: 0 40px 80px rgba(0,0,0,0.8), 0 0 0 1px rgba(15,23,42,0.9);
      padding: 32px 24px;
      backdrop-filter: blur(14px);
    }

    .header { text-align: center; margin-bottom: 30px; }
    .header h1 {
      font-size: 2rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      font-weight: 700;
      margin-bottom: 6px;
      color: #f9fafb;
    }
    .header p {
      color: var(--text-soft);
      font-size: 0.9rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
    }

    /* Inputs - Matches Probability Machine Style */
    .input-row {
      display: flex;
      gap: 15px;
      margin-bottom: 24px;
      align-items: flex-end;
      background: rgba(30, 41, 59, 0.4);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid rgba(55,65,81,0.5);
    }
    .input-group { flex: 1; }
    
    label {
      display: block;
      margin-bottom: 8px;
      color: var(--text-muted);
      font-weight: 600;
      font-size: 0.8rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
    }
    
    select {
      width: 100%;
      padding: 12px 15px;
      background: #0b1120;
      border: 1px solid rgba(75, 85, 99, 0.8);
      border-radius: 8px;
      color: #f9fafb;
      font-size: 1.1em;
      transition: border-color 0.2s;
      appearance: none;
      cursor: pointer;
    }
    select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 1px rgba(56,189,248,0.5); }

    /* Instructions */
    .instruction-text {
      text-align: center;
      color: var(--text-soft);
      font-size: 0.95rem;
      margin-bottom: 20px;
      line-height: 1.5;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }
    .highlight { color: var(--text-main); font-weight: 600; }

    /* Results Card */
    .result-card {
      background: radial-gradient(circle at top, rgba(15,23,42,0.9), rgba(2,6,23,0.95));
      border: 1px solid rgba(55,65,81,0.6);
      border-radius: 14px;
      padding: 30px;
      margin-bottom: 24px;
      display: none; /* Hidden until loaded */
    }
    .result-card.show { display: block; }

    .main-stat-label { 
      color: var(--text-soft); 
      font-size: 0.9rem; 
      text-transform: uppercase; 
      letter-spacing: 0.12em; 
      margin-bottom: 10px; 
      text-align: center;
    }

    /* Table Styling */
    .table-wrap {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      margin-top: 10px;
      border-radius: 8px;
      border: 1px solid rgba(55, 65, 81, 0.5);
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
      min-width: 600px;
    }

    .data-table thead {
      background: rgba(30, 41, 59, 0.6);
    }

    .data-table th {
      text-align: left;
      padding: 12px 16px;
      color: var(--text-muted);
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      border-bottom: 1px solid rgba(55,65,81,0.5);
      cursor: pointer;
      user-select: none;
    }
    
    .data-table th:hover { color: var(--accent); }

    .data-table td {
      padding: 12px 16px;
      color: #e5e7eb;
      border-bottom: 1px solid rgba(55, 65, 81, 0.3);
      font-variant-numeric: tabular-nums;
    }

    .data-table tbody tr:hover {
      background: rgba(56, 189, 248, 0.05);
    }

    .rank-col { width: 50px; color: var(--text-soft); font-weight: 600; }
    .manager-col { font-weight: 500; color: #f9fafb; }
    .stat-col { font-family: monospace; font-size: 1rem; }
    .featured-col { color: var(--accent); font-weight: 700; background: rgba(56, 189, 248, 0.03); }
    
    /* Footer Row */
    .league-footer {
      background: rgba(56, 189, 248, 0.08);
      font-weight: 700;
      color: var(--accent);
    }
    .league-footer td { border-bottom: none; }

    /* Comparison Colors */
    .diff-pos { color: var(--positive); }
    .diff-neg { color: var(--negative); }
    .diff-neu { color: var(--text-soft); }

    .loading { color: var(--text-soft); text-align: center; padding: 40px; }

    @media (max-width: 600px) {
      .input-row { flex-direction: column; align-items: stretch; }
      .container { padding: 24px 16px; }
    }
  </style>
</head>
<body>

<div class="shell">
  <div class="container">
    <div class="header">
      <h1>Weekly Averages</h1>
      <p>Legion of Whom Fantasy Football League</p>
    </div>

    <p class="instruction-text">
      Select a specific week to see historical performance averages. 
      <br>Use the <strong>"Compare With"</strong> dropdown to see how scoring differs between two weeks.
    </p>

    <div class="input-row">
      <div class="input-group">
        <label for="primaryWeek">Primary Week</label>
        <select id="primaryWeek">
          </select>
      </div>
      <div class="input-group">
        <label for="compareWeek" style="color:var(--accent);">Compare With (Optional)</label>
        <select id="compareWeek">
          <option value="">-- None --</option>
          </select>
      </div>
    </div>

    <div id="resultsArea" class="result-card">
      <div class="main-stat-label" id="tableTitle">Week 1 Historical Stats</div>
      
      <div class="table-wrap">
        <table class="data-table">
          <thead>
            <tr id="tableHeader">
              </tr>
          </thead>
          <tbody id="tableBody">
            </tbody>
          <tfoot id="tableFooter">
            </tfoot>
        </table>
      </div>
    </div>

    <div id="loading" class="loading">Loading database...</div>

  </div>
</div>

<script>
  let rawMatchups = [];
  let currentSort = { key: 'avg1', dir: 'desc' }; // Default sort by Primary Average

  document.addEventListener('DOMContentLoaded', async () => {
    try {
      const res = await fetch('league-scores.json');
      if (!res.ok) throw new Error("File load error");
      rawMatchups = await res.json();

      initDropdowns();
      updateTable(); // Initial Render
      
      document.getElementById('loading').style.display = 'none';
      document.getElementById('resultsArea').classList.add('show');

    } catch (err) {
      console.error(err);
      document.getElementById('loading').textContent = "Error loading data. Ensure league-scores.json is present.";
    }
  });

  function initDropdowns() {
    const primary = document.getElementById('primaryWeek');
    const compare = document.getElementById('compareWeek');
    
    // Standard 17 week fantasy season
    for(let i=1; i<=17; i++) {
      const opt1 = document.createElement('option');
      opt1.value = i;
      opt1.textContent = `Week ${i}`;
      primary.appendChild(opt1);

      const opt2 = document.createElement('option');
      opt2.value = i;
      opt2.textContent = `Week ${i}`;
      compare.appendChild(opt2);
    }

    primary.addEventListener('change', updateTable);
    compare.addEventListener('change', updateTable);
  }

  function getStatsForWeek(weekNum) {
    const stats = {};
    let totalScore = 0;
    let totalGames = 0;

    rawMatchups.forEach(m => {
      if (Number(m.week) !== weekNum) return;

      const processSide = (manager, score, opponentScore) => {
        if (!manager) return;
        const s = Number(score);
        const o = Number(opponentScore);
        if (isNaN(s)) return;

        if (!stats[manager]) stats[manager] = { 
          name: manager, score: 0, games: 0, w:0, l:0, t:0 
        };

        stats[manager].score += s;
        stats[manager].games += 1;
        
        // W-L-T Calculation
        if (s > o) stats[manager].w++;
        else if (s < o) stats[manager].l++;
        else stats[manager].t++;

        totalScore += s;
        totalGames++;
      };

      processSide(m.manager1, m.score1, m.score2);
      processSide(m.manager2, m.score2, m.score1);
    });

    // Calculate Averages
    const processed = Object.values(stats).map(p => ({
      ...p,
      average: p.games > 0 ? p.score / p.games : 0
    }));

    return {
      data: processed,
      leagueAvg: totalGames > 0 ? totalScore / totalGames : 0
    };
  }

  function updateTable() {
    const w1 = parseInt(document.getElementById('primaryWeek').value);
    const w2Val = document.getElementById('compareWeek').value;
    const isCompare = w2Val !== "";
    const w2 = isCompare ? parseInt(w2Val) : null;

    const set1 = getStatsForWeek(w1);
    
    let combinedData = [];

    if (isCompare) {
      const set2 = getStatsForWeek(w2);
      // Merge data
      // Create a map of all managers found in either set
      const managers = new Set([...set1.data.map(d=>d.name), ...set2.data.map(d=>d.name)]);
      
      combinedData = Array.from(managers).map(m => {
        const s1 = set1.data.find(x => x.name === m);
        const s2 = set2.data.find(x => x.name === m);
        
        const avg1 = s1 ? s1.average : 0;
        const avg2 = s2 ? s2.average : 0;
        
        return {
          name: m,
          avg1: avg1,
          avg2: avg2,
          diff: avg1 - avg2,
          // For sorting convenience
          sortVal: avg1 
        };
      });

      document.getElementById('tableTitle').textContent = `Comparison: Week ${w1} vs Week ${w2}`;
    } else {
      // Single Week Mode
      combinedData = set1.data.map(d => ({
        name: d.name,
        avg1: d.average,
        total: d.score,
        games: d.games,
        record: `${d.w}-${d.l}-${d.t}`
      }));
      document.getElementById('tableTitle').textContent = `Week ${w1} Historical Performance`;
    }

    renderHeader(isCompare, w1, w2);
    renderBody(combinedData, isCompare);
    renderFooter(set1.leagueAvg, isCompare ? getStatsForWeek(w2).leagueAvg : null, isCompare);
  }

  function renderHeader(isCompare, w1, w2) {
    const thead = document.getElementById('tableHeader');
    thead.innerHTML = '';

    const cols = isCompare 
      ? [
          { k: 'rank', label: 'Rank' },
          { k: 'name', label: 'Manager' },
          { k: 'avg1', label: `Wk ${w1} Avg` },
          { k: 'avg2', label: `Wk ${w2} Avg` },
          { k: 'diff', label: '+/-' }
        ]
      : [
          { k: 'rank', label: 'Rank' },
          { k: 'name', label: 'Manager' },
          { k: 'record', label: 'Record' },
          { k: 'total', label: 'Total Pts' },
          { k: 'games', label: 'Games' },
          { k: 'avg1', label: 'Average' }
        ];

    cols.forEach(c => {
      const th = document.createElement('th');
      th.textContent = c.label;
      if (c.k === currentSort.key) th.style.color = 'var(--accent)';
      
      th.onclick = () => {
        if (currentSort.key === c.k) {
          currentSort.dir = currentSort.dir === 'desc' ? 'asc' : 'desc';
        } else {
          currentSort.key = c.k;
          currentSort.dir = 'desc'; // Default desc for stats
          if (c.k === 'name') currentSort.dir = 'asc';
        }
        updateTable(); // Re-render with new sort
      };
      thead.appendChild(th);
    });
  }

  function renderBody(data, isCompare) {
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '';

    // Sort Data
    data.sort((a, b) => {
      const valA = a[currentSort.key];
      const valB = b[currentSort.key];
      
      // Tie breaking
      if (valA === valB) return 0;
      
      if (typeof valA === 'string') {
        return currentSort.dir === 'asc' 
          ? valA.localeCompare(valB) 
          : valB.localeCompare(valA);
      }
      return currentSort.dir === 'desc' ? (valB - valA) : (valA - valB);
    });

    let rank = 1;
    data.forEach((row, idx) => {
      // Handle Rank Ties
      if (idx > 0 && row[currentSort.key] !== data[idx-1][currentSort.key]) {
        rank = idx + 1;
      }

      const tr = document.createElement('tr');
      
      if (isCompare) {
        const diffClass = row.diff > 0 ? 'diff-pos' : (row.diff < 0 ? 'diff-neg' : 'diff-neu');
        const diffSign = row.diff > 0 ? '+' : '';
        
        tr.innerHTML = `
          <td class="rank-col">${rank}</td>
          <td class="manager-col">${row.name}</td>
          <td class="stat-col featured-col">${row.avg1.toFixed(2)}</td>
          <td class="stat-col">${row.avg2.toFixed(2)}</td>
          <td class="stat-col ${diffClass}">${diffSign}${row.diff.toFixed(2)}</td>
        `;
      } else {
        tr.innerHTML = `
          <td class="rank-col">${rank}</td>
          <td class="manager-col">${row.name}</td>
          <td class="stat-col">${row.record}</td>
          <td class="stat-col">${row.total.toLocaleString()}</td>
          <td class="stat-col">${row.games}</td>
          <td class="stat-col featured-col">${row.avg1.toFixed(2)}</td>
        `;
      }
      tbody.appendChild(tr);
    });
  }

  function renderFooter(avg1, avg2, isCompare) {
    const foot = document.getElementById('tableFooter');
    foot.innerHTML = '';
    
    const tr = document.createElement('tr');
    tr.className = 'league-footer';

    if (isCompare) {
      const diff = avg1 - avg2;
      const diffSign = diff > 0 ? '+' : '';
      tr.innerHTML = `
        <td></td>
        <td>LEAGUE AVG</td>
        <td class="stat-col">${avg1.toFixed(2)}</td>
        <td class="stat-col">${avg2.toFixed(2)}</td>
        <td class="stat-col">${diffSign}${diff.toFixed(2)}</td>
      `;
    } else {
      tr.innerHTML = `
        <td></td>
        <td>LEAGUE AVG</td>
        <td></td>
        <td></td>
        <td></td>
        <td class="stat-col">${avg1.toFixed(2)}</td>
      `;
    }
    foot.appendChild(tr);
  }

</script>
</body>
</html>
